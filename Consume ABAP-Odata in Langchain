Consuming ABAP OData APIs in a Langchain chat model involves two main parts:

ABAP Side (Exposing the OData API): As an ABAP developer, you would create and expose the OData service from your SAP system. This is the prerequisite for consumption.
Langchain Side (Consuming the OData API): This is where you write Python code using Langchain to interact with the exposed OData service.
Given your role as an ABAP developer and the ABAP styling requirements, it's important to clarify that the consumption logic itself will be written in Python (for Langchain), not ABAP. The ABAP context applies to how you would create the service that Langchain then consumes.

1. ABAP Side: Exposing the OData API (Prerequisite)
As an ABAP developer, you would use the Service Gateway (SEGW) transaction to create and expose your OData service. This involves:

Creating a Project: In SEGW, create a new project (e.g., Z_MM_PRODUCT_SRV).
Defining the Data Model:
Entity Types: Define the structure of your data (e.g., Product, MaterialStock).
For MaterialStock, you might have properties like Material (Key), Plant (Key), StockQuantity, Unit.
Entity Sets: Create collections of your entity types (e.g., ProductSet, MaterialStockSet).
Implementing the Service:
Redefine Methods: For each entity set, you'll redefine methods in the DPC_EXT class (Data Provider Class Extension) to fetch, create, update, or delete data.
For MaterialStockSet, you'd implement the GET_ENTITYSET method to read stock data from underlying SAP tables (e.g., MARD, MARC).
Example (Conceptual ABAP Logic within DPC_EXT->MATERIALSTOCKSET_GET_ENTITYSET):
* This is a conceptual example of ABAP logic within a DPC_EXT method.
* It's not a full report and doesn't follow all report-specific guidelines,
* as the core task here is service implementation.
METHOD /iwbep/if_mgw_appl_srv_runtime~get_entityset.

  DATA: lt_key_tab TYPE /iwbep/t_mgw_name_value_pair,
        ls_filter_select_options TYPE /iwbep/s_mgw_select_option,
        lv_material TYPE matnr,
        lv_plant    TYPE werks_d,
        lt_material_stock TYPE STANDARD TABLE OF zmms_material_stock, " Structure for OData entity
        ls_material_stock TYPE zmms_material_stock.

  " Get filter parameters from the OData request
  io_tech_request_context->get_os_segment_key( IMPORTING et_key_tab = lt_key_tab ).
  io_tech_request_context->get_filter( IMPORTING et_filter_select_options = DATA(lt_filter_options) ).

  " Example: Extract Material and Plant from filter (simplified)
  LOOP AT lt_filter_options INTO ls_filter_select_options WHERE iv_property_path = 'Material'.
    READ TABLE ls_filter_select_options-it_select_options INTO DATA(ls_option) INDEX 1.
    IF sy-subrc = 0 AND ls_option-option = 'EQ'.
      lv_material = ls_option-low.
    ENDIF.
  ENDLOOP.

  LOOP AT lt_filter_options INTO ls_filter_select_options WHERE iv_property_path = 'Plant'.
    READ TABLE ls_filter_select_options-it_select_options INTO ls_option INDEX 1.
    IF sy-subrc = 0 AND ls_option-option = 'EQ'.
      lv_plant = ls_option-low.
    ENDIF.
  ENDLOOP.

  " Fetch data from SAP tables based on filters
  IF lv_material IS NOT INITIAL AND lv_plant IS NOT INITIAL.
    SELECT SINGLE matnr werks lbkum FROM mard INTO CORRESPONDING FIELDS OF ls_material_stock
      WHERE matnr = lv_material AND werks = lv_plant.

    IF sy-subrc = 0.
      ls_material_stock-material = ls_material_stock-matnr.
      ls_material_stock-plant = ls_material_stock-werks.
      ls_material_stock-stockquantity = ls_material_stock-lbkum.
      ls_material_stock-unit = 'PC'. " Example unit, fetch from MARA/MARC if needed
      APPEND ls_material_stock TO lt_material_stock.
    ENDIF.
  ENDIF.

  " Return the data
  copy_data_to_ref( EXPORTING is_data = lt_material_stock
                    CHANGING  cr_data = er_entityset ).

ENDMETHOD.

Registering the Service: In /IWFND/MAINT_SERVICE, register your service to make it accessible.
Once activated, your OData service will be available at a URL like: https://<your_sap_host>:<port>/sap/opu/odata/sap/Z_MM_PRODUCT_SRV/MaterialStockSet?$filter=Material eq 'M-01' and Plant eq '1000'

2. Langchain Side: Consuming the OData API
This part involves writing Python code to define tools that call your ABAP OData service and then integrating these tools with a Langchain agent.

Key Steps:

Install necessary libraries: pip install langchain openai requests
Implement Python functions to call OData: These functions will use the requests library to make HTTP calls to your SAP OData service, handle authentication, and parse responses.
Wrap these functions as Langchain Tool objects: This makes them callable by an LLM agent.
Create a Langchain Agent: Initialize an LLM and an agent, providing it with your custom tools.
Interact with the Agent: Ask questions, and the agent will decide when and how to use your OData tools.
import requests
import json
import os
from langchain.agents import AgentExecutor, create_react_agent
from langchain.tools import Tool
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate

# --- Configuration ---
# IMPORTANT: Replace with your actual SAP OData service details and credentials.
# For production, use environment variables or a secure configuration management.
SAP_ODATA_BASE_URL = "https://<your_sap_host>:<port>/sap/opu/odata/sap/Z_MM_PRODUCT_SRV/"
SAP_USERNAME = "your_sap_user"
SAP_PASSWORD = "your_sap_password"

# Set your OpenAI API key (e.g., via environment variable OPENAI_API_KEY)
# os.environ["OPENAI_API_KEY"] = "YOUR_OPENAI_API_KEY"

# --- Python Functions to Call ABAP OData API ---

def get_material_stock(material_id: str, plant_id: str) -> str:
    """
    Fetches the stock level for a given material and plant from SAP via OData.
    Expects material_id (string) and plant_id (string).
    Example input: {"material_id": "M-01", "plant_id": "1000"}
    """
    if not material_id or not plant_id:
        return "Error: Both material_id and plant_id are required."

    # Construct the OData URL with filter
    # Note: OData filter syntax requires single quotes for string values
    endpoint = f"MaterialStockSet?$filter=Material eq '{material_id}' and Plant eq '{plant_id}'"
    url = f"{SAP_ODATA_BASE_URL}{endpoint}&$format=json"

    try:
        response = requests.get(
            url,
            auth=(SAP_USERNAME, SAP_PASSWORD),
            headers={'Accept': 'application/json'},
            verify=False  # Set to True in production with valid SSL certificates
        )
        response.raise_for_status() # Raise an HTTPError for bad responses (4xx or 5xx)
        data = response.json()

        # Parse the OData JSON response structure
        # OData v2 typically returns data under 'd' and results under 'results'
        if data and 'd' in data and 'results' in data['d'] and data['d']['results']:
            first_result = data['d']['results'][0]
            stock_quantity = first_result.get('StockQuantity', 'N/A')
            unit = first_result.get('Unit', '')
            return f"Stock for material {material_id} in plant {plant_id}: {stock_quantity} {unit}"
        else:
            return f"No stock data found for material '{material_id}' in plant '{plant_id}'."

    except requests.exceptions.HTTPError as e:
        return f"HTTP error occurred while calling SAP OData service: {e} - Response: {response.text}"
    except requests.exceptions.ConnectionError as e:
        return f"Connection error occurred while calling SAP OData service: {e}"
    except requests.exceptions.Timeout as e:
        return f"Timeout occurred while calling SAP OData service: {e}"
    except requests.exceptions.RequestException as e:
        return f"An unexpected request error occurred: {e}"
    except json.JSONDecodeError as e:
        return f"Error decoding JSON response from SAP OData service: {e} - Response: {response.text}"
    except Exception as e:
        return f"An unexpected error occurred: {e}"

# --- Langchain Tool Definition ---

# Define the tools that the LLM agent can use.
# Each tool is a Python function wrapped with a descriptive name and explanation.
tools = [
    Tool(
        name="get_material_stock",
        func=get_material_stock,
        description="""
        Use this tool to retrieve the current stock quantity for a specific material in a given plant from SAP.
        Input should be a JSON string with two keys: 'material_id' (string) and 'plant_id' (string).
        For example: {"material_id": "M-01", "plant_id": "1000"}
        """
    ),
    # You can add more tools here for other OData operations, e.g.:
    # Tool(
    #     name="get_material_details",
    #     func=get_material_details,
    #     description="""
    #     Use this tool to get general details about a material from SAP.
    #     Input: {"material_id": "M-01"}
    #     """
    # ),
]

# --- Langchain Agent Initialization ---

# Initialize the Chat model (e.g., OpenAI's GPT-3.5-turbo or GPT-4)
# Ensure OPENAI_API_KEY environment variable is set.
llm = ChatOpenAI(temperature=0, model="gpt-3.5-turbo")

# Define the prompt for the agent. This guides how the agent thinks and uses tools.
prompt = PromptTemplate.from_template("""
Answer the following questions as best you can. You have access to the following tools:

{tools}

Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [{tool_names}]
Action Input: the input to the action (must be a JSON string if the tool description specifies it)
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin!

Question: {input}
Thought:{agent_scratchpad}
""")

# Create the agent
agent = create_react_agent(llm, tools, prompt)

# Create the AgentExecutor to run the agent
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=True, # Set to True to see the agent's thought process
    handle_parsing_errors=True # Helps in debugging if LLM output is malformed
)

# --- Interaction Loop ---

if __name__ == "__main__":
    print("Langchain Agent connected to SAP OData service via custom tools.")
    print("Type 'exit' to quit.")

    while True:
        user_query = input("\nEnter your query: ")
        if user_query.lower() == 'exit':
            break

        try:
            # Invoke the agent with the user's query
            response = agent_executor.invoke({"input": user_query})
            print(f"\nAgent's Final Response: {response['output']}")
        except Exception as e:
            print(f"An error occurred during agent execution: {e}")

How it works:

User Query: The user asks a question like "What is the stock for material M-01 in plant 1000?"
Agent's Thought Process: The Langchain agent (powered by the LLM) receives the query. Based on the description of the get_material_stock tool, it realizes that this tool can answer the question.
Action Selection: The agent decides to call the get_material_stock tool.
Parameter Extraction: It extracts "M-01" for material_id and "1000" for plant_id from the user's query and formats them as a JSON string as specified in the tool's description.
Tool Execution: The get_material_stock Python function is called with these parameters.
OData Call: This function constructs the OData URL and makes an HTTP GET request to your SAP system.
Response Handling: The SAP OData service responds with JSON data. The Python function parses this data and returns a formatted string (e.g., "Stock for material M-01 in plant 1000: 500 PC").
Observation: The agent receives this string as an "Observation."
Final Answer: The agent then formulates a user-friendly "Final Answer" based on the observation.
This setup allows your Langchain chat model to dynamically query and retrieve real-time data from your SAP system, bridging the gap between conversational AI and enterprise data.
